<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>

/*.counties {
  fill: none;

}

.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}
*/

body {
    width: 100%;
    height: 100%;
    background-color: #fff;
}

#projectTitle{
	font-family: 'Libre Baskerville', serif;
	text-align: center;
	font-weight: 400;
	padding-top: 30px;
	padding-bottom: 5px;
}

#myName{
	/*font-family: 'Libre Baskerville', serif;*/
	font-family: 'Roboto Condensed', sans-serif;
	text-align: center;
	padding-bottom: 50px;
}

.description{
	 font-family: 'Roboto Condensed', sans-serif;
	 text-align: justify;
	 text-justify: inter-word;
	 padding-bottom: 20px;
  	 
}

#maincontainer{
	 font-family: 'Roboto Condensed', sans-serif;
	 display: block;
		margin: auto;
		padding-bottom: 50px;
	/*position:absolute*/

}
#source{
	font-family: 'Roboto Condensed', sans-serif;
	font-size: 11px;
	 text-align: justify;
	 text-justify: inter-word;
	 padding-bottom: 30px;

}

 div.tooltip { 
          		position: absolute;			
				color: #222;			
				width: 170px;					
				height: auto;					
				padding: 10px;				
				font: 12px Roboto Condensed;	
				background-color: #fff;	
				border: 2px;	
				border:1px solid rgba(0,0,0,0.5);
				pointer-events: none;	
				box-shadow: 2px 2px 2px rgba(169,169,169,0.5);  
      }
}
</style>
<link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300,300italic,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@700&display=swap" rel="stylesheet">

<script
  src="https://code.jquery.com/jquery-3.5.0.min.js"
  integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ="
  crossorigin="anonymous"></script>
<script type="text/javascript" src="bootstrap.min.js"></script>
<link href="bootstrap.min.css" rel="stylesheet" type="text/css" />
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src= 'https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js'></script>
<!-- <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> -->
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://unpkg.com/d3-geo-scale-bar@1.0.2/build/d3-geo-scale-bar.min.js"></script>


</head>
</body>

<div class="container-fluid">
	
	<div class="row">
        <div class="col-md-3 col-sm-12"></div>
        <div class="col-md-6 col-sm-12">
        	<div class="row">
        		<h1 id='projectTitle' class="display-4">Does political affiliation impact migration?</h1>
        	</div>
        </div>
        <div class="col-md-3 col-sm-12"></div>
    </div>
    <div class="row">
    	<div class="col-md-4 col-sm-12"></div>
        <div class="col-md-4 col-sm-12">
        	<div id = "myName">By <b>Kuhu Gupta</b></div>	
        </div>
        <div class="col-md-4 col-sm-12"></div>
    </div>
    <div class="row">
    	<div class="col-md-4 col-sm-12"></div>
    	<div class="col-md-4 col-sm-12">
    		<p class= 'description'>Partisan polarization in the United States is not only observed in the political and social life of its citizens but also patterns of county-county migration. County-to-county migration flows connect counties with similar political affiliations. Politically extreme counties have geographically restricted migration patterns and only have inbound and outbound migrant traffic from its neighboring states. However, population and urbanization of few counties, especially politically extreme Democratic counties, show an entirely different view. The migration flows from these counties spans to counties all across the country, irrespective of their political affiliation. 
</p>
    	</div>
    	<div class="col-md-4 col-sm-12"></div>
    </div>
    <div class="row"> 
    	<div class="col-md-2 col-sm-12"></div>
        <div class="col-md-9 col-sm-12">
        	<div class="row">
        		<div id = "maincontainer">
					<div id = "map"></div>	
				</div>
        	</div>
        </div>
        <div class="col-md-2 col-sm-12"></div>
    </div>
     <div class="row"> 
    	<div class="col-md-3 col-sm-12"></div>
        <div class="col-md-6 col-sm-12">
        	<div id='source'class="row">
        		<b>Source:</b>  Andris, Clio, 2019, "Replication Data for: Migration and Political Polarization in the U.S.: An Analysis of the County-level Migration Network", https://doi.org/10.7910/DVN/ONBJ5I, Harvard Dataverse, V1, UNF:6:qi1JOvpH/iv5kwJy8zy02g== [fileUNF]
        	</div>
        </div>
        <div class="col-md-3 col-sm-12"></div>
    </div>
</div>



<script>

	let w = 1200;
  	let  h = 600;
	let links;
	const projection = d3.geoAlbers()
	let path = d3.geoPath();
	let coming, going;    
	var isClicked = false; 

	var lineSize = d3.scaleLog().range([1,10]).domain([19, 37393]);

	var color_scheme = d3.scaleLinear()
	    	.domain([0, 0.25, 0.5, 0.75, 1] )
	    	.range(['#0571b0','#92c5de','#f7f7f7','#f4a582','#ca0020']);

    function color_county(value){

    	if (value == undefined)
    		return '#fff'
    	else
    		return color_scheme(value);
    }

    
    
    var svg = d3.select("#map")
		.append("svg")
		.attr("width", w)
		.attr("height", h)
		.style("background", "#fff");

	var  scaleBar = d3.geoScaleBar()
	    .projection(projection)
	    .size([w, h])
		.left(.829)
		.top(0.85)
 		.units(d3.geoScaleMiles)
		.label("Miles") // The label on top of the scale bar
	    .labelAnchor("middle")
	    .tickFormat(d3.format(","));
  
  svg.append("g")
      .call(scaleBar);



	svg.append("g")
	  .attr("class", "legendLinear")
	  .attr("transform", "translate(850,550)");

	var legendLinear = d3.legendColor()
	  .shapeWidth(45)
	  .shapeHeight(8)
	  .shapePadding(0.8)
	  .labels(["0",'0.25','0.5','0.75','1'])
	  .labelFormat(d3.format(""))
	  .title('GOP Percentage')
	  .cells(5)
	  .orient('horizontal')
	  .scale(color_scheme);

	svg.select(".legendLinear")
	  .call(legendLinear);


	var ordinal = d3.scaleOrdinal()
	  .domain(["Inbound Migration", "Outbound Migration"])
	  .range(["#d65200","#36ab91"]);

	svg.append("g")
	  .attr("class", "legendOrdinal")
	  .attr("transform", "translate(850,450)");

	var legendOrdinal = d3.legendColor()
	  .shape("path", d3.symbol().type(d3.symbolSquare).size(150)())
	  .title('Migration Links')
	  .shapePadding(10)
	  .scale(ordinal);

	svg.select(".legendOrdinal")
	  .call(legendOrdinal);



	// svg.append("g")
 //  		.attr("class", "legendSizeLine")
 //  		.attr("transform", "translate(850, 400)");

	// var legendSizeLine = d3.legendSize()
 //      .scale(lineSize)
 //      .shape("line")
 //      .orient("horizontal")
 //      //otherwise labels would have displayed:
 //      // 0, 2.5, 5, 10
 //      .labels([20,100,1000,38000])
 //      .labelWrap(30)
 //      .shapeWidth(40)
 //      .labelAlign("start")
 //      .shapePadding(10);

	// svg.select(".legendSizeLine")
 //  		.call(legendSizeLine);


	svg.append("svg:image")
		.attr('x', 1020)
		.attr('y', 420)
		.attr('width', 60)
		.attr('height', 80)
		.attr("xlink:href", "northarrow.svg")
	


	var tooltip = d3.select("#maincontainer")
					.append("div")	
					.attr("class", "tooltip")       
        			.style("opacity", 0);

    var tooltipLinks = d3.select("#maincontainer")
					.append("div")	
					.attr("class", "tooltip")       
        			.style("opacity", 0);

					

	var g = svg.append("g");

	d3.queue()
	    .defer(d3.json, "https://d3js.org/us-10m.v1.json")
	    .defer(d3.json, "county_nodes.json")
	    .defer(d3.json, "flows_data.json")
	    .defer(d3.csv, "going.csv")
	    .defer(d3.csv, "coming.csv")
	    .await(createMap);

    function createMap(error, us, nodes, flows, going, coming){
    	if (error) throw error;
    	
    	const countiesGeo = us.objects.counties.geometries;
    	links = flows;

    	for (const i in nodes) { // Loop through unemployment countyid
			for (const j in countiesGeo) { // Loop through countiesGeo
				if (nodes[i].fips === countiesGeo[j].id) { // If ids match
					countiesGeo[j].properties = {};
					for (const k in nodes[i]) {
						if (k !== "countyid") { // No need to add countyid
							countiesGeo[j].properties[k] = nodes[i][k];
						}
					}
					break;
				}
			}
		}

		
		const linkedByIndex = {};
	  	links.forEach(d => {
	    	linkedByIndex[`${d.fips_ori},${d.fips_des}`] = d.exemptions;
	  	});
  		

  		var findcountLinked;
	  	function isConnected(a, b) {
	  		findcountLinked = linkedByIndex[`${a},${b}`] || linkedByIndex[`${b},${a}`] || a === b;
	  		return findcountLinked;
	  	}

	  	function getExemptions(a,b){
	  		var Inbound = linkedByIndex[`${a},${b}`];
	  		var Outbound = linkedByIndex[`${b},${a}`]; 
	  		var exemptions = [checkUndefined(Inbound),checkUndefined(Outbound)];
	  		return exemptions;
	  		
	  	}

	  	function checkUndefined(value){
	  		if (value === undefined){
	  			return 0;
	  		}
	  		else{
	  			return parseInt(value);
	  		}
	  	}


	  	function findConnectedCounty(selectCountId){
	  		var resultGoing = links.filter(obj =>{ return obj.fips_ori == selectCountId});
	  		var resultComing = links.filter(obj =>{ return obj.fips_des == selectCountId});
	  		return [resultGoing,resultComing]
	  	}

	  	function countMigrants(migrantArray){
	  		// console.log(migrantArray)
	  		var goingMigrants = 0, comingMigrants = 0;
	  		migrantArray[0].forEach(function(entry){
	  			goingMigrants = goingMigrants + parseInt(entry.exemptions);
	  		})
	  		migrantArray[1].forEach(function(entry){
	  			comingMigrants = comingMigrants + parseInt(entry.exemptions);
	  		})

	  		return [goingMigrants,comingMigrants]
	  	}


	  	function findcountyId(countyName){
	  		console.log(countyName);
	  		var result = nodes.filter(obj => { return obj.name === countyName })
	  		console.log(result);
	  		
	  	}

	  	function extractId(data){
	  		var connected = [];
	  		var connectedCounty = data[0].concat(data[1])
	  		data[0].forEach(d => {connected.push(d.fips_des);})
	  		data[1].forEach(d => {connected.push(d.fips_ori);})

	  		return [...new Set(connected)];
	  	}

		let features = topojson.feature(us, us.objects.counties).features
	
	    let counties =	g.selectAll('path')
	    	.data(topojson.feature(us, us.objects.counties).features)
			.enter().append("path")
			.attr("class", "counties")
			.attr("id", function(d) { return 'county' + d.id; })
			.attr("d", path)
			.attr("fill", d => color_county(d.properties['gop_pct_2016']))
	    	.on('mouseover',fade(0.04,'over',isClicked))
	    	.on('mouseout',fade(1,'out',isClicked))
	    	.attr('stroke','white')
	    	.attr('stroke-width',0.5);
	    
	   

		let circles = g.selectAll("circle")
			.data(features)
			.enter().append("circle")
			.attr("cx", function(d) {
				var ctroid = path.centroid(d)[0];
				return ctroid;
			})
			.attr("cy", function(d) {
			var ctroid = path.centroid(d)[1];
			return ctroid;
			})
			.attr("r", 5)
			.attr("class", "circ")
			.attr("id", function(d) { return 'circle' + d.id ;})
			.attr("fill",'black')
			.attr("fill-opacity",0)
			.on('mouseover',fade(0.04,'over',isClicked))
	    	.on('mouseout',fade(1,'out',isClicked))
			// .attr("stroke", "black")
			.on('click', clickedCounty);



    	function clickedCounty(selected){
    		isClicked = true;
    		// console.log(selected)
    		var selname = selected.properties.name + '_' + selected.id;
    		var selectedx = path.centroid(selected)[0];
  			var selectedy = path.centroid(selected)[1];

  			var data = findConnectedCounty(selected.id);
  			// console.log(data[0])


  			g.selectAll(".goingline")
			.attr("stroke-dasharray", 0)
			.remove()
  
			g.selectAll(".goingline")
			.data(data[0])
			.enter().append("path")
			.attr("class", "goingline")
			.attr("d", function(d){
				var cId = d.fips_des;
				var theCounty = d3.select("#circle" + cId);
				var togetCentroid = theCounty._groups[0][0].__data__;

				var destinationx = path.centroid(togetCentroid)[0];
				var destinationy = path.centroid(togetCentroid)[1];

				var dx = destinationx - selectedx, 
					dy = destinationy - selectedy,
					dr = Math.sqrt(dx * dx + dy * dy);

				return "M" + selectedx + "," + selectedy + "A" + dr + "," + dr +
					" 0 0,1 " + destinationx + "," + destinationy;

			})
			.call(transition)
			.attr('stroke-width',function(d){
				var lWidth = lineSize(parseInt(d.exemptions));
				// console.log(lWidth);
				return lWidth;
			})
			.attr('stroke','#36ab91')
			.attr("fill", "none")
	  		.attr("opacity", 0.7)
	  		.attr("stroke-linecap", "round")
	  		

	  		
	  		g.selectAll(".comingline")
			.attr("stroke-dasharray", 0)
			.remove()
  
			g.selectAll(".comingline")
			.data(data[1])
			.enter().append("path")
			.attr("class", "comingline")
			.attr("d", function(d){
				var cId = d.fips_ori;
				var theCounty = d3.select("#circle" + cId);
				var togetCentroid = theCounty._groups[0][0].__data__;
				

				var originx = path.centroid(togetCentroid)[0];
				var originy = path.centroid(togetCentroid)[1];

				 var dx = selectedx - originx,
					dy = selectedy - originy,
					dr = Math.sqrt(dx * dx + dy * dy);
					    return "M" + originx + "," + originy + "A" + dr + "," + dr +
					" 0 0,1 " + selectedx + "," + selectedy;

			})
			.call(transition)
			.attr('stroke-width',function(d){
				var lWidth = lineSize(parseInt(d.exemptions));
				// console.log(lWidth);
				return lWidth;
			})
			.attr('stroke','#d65200')
			// .style('stroke-dasharray', '20,5,5,5,5,5')
			.attr("fill", "none")
	  		.attr("opacity", 0.7)
	  		.attr("stroke-linecap", "round")

	  		handleCountyColor(data,selected);

		}

		function handleCountyColor(data,chosen){
			tooltip.remove();
			var connectId = extractId(data);
	  		connectId.push(chosen.id);
	  		counties.style('fill-opacity', function(o){
	  				const connectOpacity = (connectId.includes(o.id)) ? 1 : 0.1;
	    			this.setAttribute('fill-opacity', connectOpacity);
	     			return connectOpacity;
	    	}) 
	    	counties.on('mouseover',function(o){
	    		if(connectId.includes(o.id)){
	    			tooltipLinks.transition()    
		            		.duration(200)    
		            		.style("opacity", 1); 
		     
		            		var mouse = d3.mouse(d3.select('.counties').node()); 
		            		if(chosen.id === o.id){
		            			var Migrants = findConnectedCounty(o.id);
		            			var cMigrants = countMigrants(Migrants);
			            		var goppct = parseFloat(o.properties.gop_pct_2016).toFixed(2);
			            	tooltipLinks.html("<font size=3>" + "<b>" + o.properties.namelsad + "</b>" + "</font>" + "<br/>" + o.properties.state + "<br/>" + "<br/>" + " GOP Percentage " + "&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;" + goppct + "<br/>" + "Population " + "&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " + o.properties.pop_16 + "<br/>" + "Outbound Migrants" + "&nbsp; &nbsp; &nbsp;" + cMigrants[0] + "<br/>" + "Inbound Migrants" + "&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;" + cMigrants[1] ).style("left", (mouse[0]+ 25) + "px").style("top", (mouse[1] - 28) + "px");
		            		}
		            		else{
		            			var exempt = getExemptions(chosen.id,o.id);
		            		tooltipLinks.html("<font size=3>" + "<b>" + o.properties.name + "-" + chosen.properties.name + "</b>" + "</font>" + "<br/>" + o.properties.state + "-" + chosen.properties.state + "<br/>" + "<br/>" + "Inbound Migrants" + "&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;" + exempt[0] + "<br/>" + "Outbound Migrants" + "&nbsp; &nbsp; &nbsp; &nbsp; " + exempt[1]).style("left", (mouse[0]+ 25) + "px").style("top", (mouse[1] - 28) + "px");
		            		}

	    		}else{
		    			 tooltipLinks.transition()    
		            	.duration(300)    
		            	.style("opacity", 0); 
		    		}
	    	})

		}


		function transition(path) {
		  path.transition()
		      .duration(1500)
		      .attrTween("stroke-dasharray", tweenDash);
		}

		function tweenDash() {
		  var l = this.getTotalLength(),
		      i = d3.interpolateString("0," + l, l + "," + l);
		  return function(t) { return i(t); };
		}

		
	    function fade(opacity, state){
	    	return d => {
	    		
	    		if(!isClicked){
		    		if(!($.isEmptyObject(d.properties)))
		    		{
			    		if(state == 'over'){
			    			tooltip.transition()    
			            		.duration(200)    
			            		.style("opacity", 0.8);  

			            	
			            	var Migrants = findConnectedCounty(d.id);
			            	var cMigrants = countMigrants(Migrants);
			            	var mouse = d3.mouse(d3.select('.counties').node()); 
			            	var goppct = parseFloat(d.properties.gop_pct_2016).toFixed(2);
			            	tooltip.html("<font size=3>" + "<b>" + d.properties.namelsad + "</b>" + "</font>" + "<br/>" + d.properties.state + "<br/>" + "<br/>" + " GOP Percentage " + "&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;" + goppct + "<br/>" + "Population " + "&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " + d.properties.pop_16 + "<br/>" + "Outbound Migrants" + "&nbsp; &nbsp; &nbsp;" + cMigrants[0] + "<br/>" + "Inbound Migrants" + "&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;" + cMigrants[1] ).style("left", (mouse[0]+ 30) + "px").style("top", (mouse[1] - 80) + "px");   
			    		} else{
			    			 tooltip.transition()    
			            	.duration(300)    
			            	.style("opacity", 0); 
			    		}

			    		counties.style('fill-opacity', function(o){
			    			const thisOpacity = isConnected(d.id, o.id) ? 1: opacity;
			    			this.setAttribute('fill-opacity', thisOpacity);
			     			return thisOpacity;
			    		})   	
					}    	
				}
			}
	    	
	    }


		svg.append("path")
	      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	      .attr("class", "states")
	      .attr('stroke', 'black')
	      .attr('fill','none')
	      .attr('stroke-width', 1)
	      .attr("d", path)

	    svg.append("path")
	      .attr("d", path(topojson.feature(us, us.objects.nation)))
	      .attr('fill','none')
	      .attr('stroke', 'black')
	      .attr('stroke-width', 1);
	}

</script>
</body>
</html>